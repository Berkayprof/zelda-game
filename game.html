<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zelda-achtige Game</title>
  <link rel="icon" href="https://i.ibb.co/DfJSTmCx/download.jpg">
  <!-- Three.js CDN -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/PointerLockControls.js"></script>
  <!-- NippleJS (optioneel voor mobiel) -->
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
  <style>
    /* Canvas & layout */
    html, body {
      margin:0; padding:0; height:100%; overflow:hidden; background:#0f172a; font-family:system-ui, Arial, sans-serif;
    }
    #hud {
      position:fixed; top:10px; left:10px; right:10px; display:flex; align-items:center; gap:12px; z-index:10;
    }
    .bar {
      height:16px; background:#1f2937; border-radius:8px; overflow:hidden; width:180px; border:1px solid #334155;
    }
    .bar-fill { height:100%; width:0%; transition:width .15s; }
    .bar.health .bar-fill { background:#ef4444; }
    .bar.stamina .bar-fill { background:#22c55e; }
    #hotbar {
      display:flex; gap:8px; align-items:center;
    }
    .slot {
      width:36px; height:36px; border:2px solid #64748b; border-radius:6px; background:#0b1220; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-weight:bold;
    }
    #quest {
      margin-left:auto; padding:8px 12px; background:#111827cc; color:#e5e7eb; border:1px solid #374151; border-radius:8px; font-size:14px;
    }
    #overlay {
      position:fixed; inset:0; background:#000000cc; color:#fff; display:none; align-items:center; justify-content:center; flex-direction:column; gap:12px; z-index:20; text-align:center; padding:20px;
    }
    #overlay h2 { margin:0 0 8px 0; }
    #dialog {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#111827cc; color:#fff; border:1px solid #374151; border-radius:10px; padding:12px 16px; display:none; z-index:15; max-width:80%;
    }
    #pauseBtn {
      position:fixed; top:10px; right:10px; z-index:15; padding:8px 12px; border:1px solid #374151; border-radius:8px; background:#111827cc; color:#e5e7eb; cursor:pointer;
    }
    #mobile-controls {
      position:fixed; bottom:10px; left:10px; right:10px; display:flex; justify-content:space-between; z-index:12; pointer-events:auto;
    }
    #left-stick, #right-stick {
      width:140px; height:140px; background:#0b122020; border:1px dashed #334155; border-radius:50%;
    }
    /* Tips */
    #tips {
      position:fixed; bottom:10px; right:10px; z-index:13; background:#111827cc; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:8px 12px; font-size:12px;
    }
  </style>
</head>
<body>
  <button id="pauseBtn">Pauze</button>
  <div id="hud">
    <div class="bar health"><div id="healthFill" class="bar-fill"></div></div>
    <div class="bar stamina"><div id="staminaFill" class="bar-fill"></div></div>
    <div id="hotbar">
      <div class="slot" title="Slot 1">1</div>
      <div class="slot" title="Slot 2">2</div>
      <div class="slot" title="Slot 3">3</div>
      <div class="slot" title="Slot 4">4</div>
    </div>
    <div id="quest">Zoek de smid in het dorp (E om te praten)</div>
  </div>
  <div id="dialog"></div>
  <div id="overlay"></div>
  <div id="tips">
    <div><b>Besturing:</b> WASD lopen, Shift sprint, muisklik zwaard, E praten</div>
    <div><b>Doel:</b> Voltooi quest â†’ mijn â†’ training â†’ battle â†’ eindbaas</div>
  </div>
  <div id="mobile-controls" style="display:none;">
    <div id="left-stick"></div>
    <div id="right-stick"></div>
  </div>
  <script>
    // ====== Basis setup ======
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f172a);
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 500);
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);
    const dir = new THREE.DirectionalLight(0xffffff, 0.7);
    dir.position.set(30,50,30);
    scene.add(dir);

    // Grond
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshStandardMaterial({ color:0x264653 }));
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Simpele bomen/obstakels (collision)
    const obstacles = [];
    function addObstacle(x,z) {
      const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,3,12), new THREE.MeshStandardMaterial({ color:0x8d5524 }));
      trunk.position.set(x,1.5,z);
      const crown = new THREE.Mesh(new THREE.SphereGeometry(2.2,16,16), new THREE.MeshStandardMaterial({ color:0x2a9d8f }));
      crown.position.set(x,4,z);
      const group = new THREE.Group();
      group.add(trunk); group.add(crown);
      group.userData = { aabb: new THREE.Box3().setFromObject(group) };
      scene.add(group);
      obstacles.push(group);
    }
    for (let i=0;i<12;i++) addObstacle((Math.random()*160-80)|0, (Math.random()*160-80)|0);

    // Dorp platform en smid
    const village = new THREE.Mesh(new THREE.CircleGeometry(25, 32), new THREE.MeshStandardMaterial({ color:0x386641 }));
    village.rotation.x = -Math.PI/2; village.position.set(0,0.001,0);
    scene.add(village);

    const smith = new THREE.Mesh(new THREE.BoxGeometry(1.2,2,1.2), new THREE.MeshStandardMaterial({ color:0xbb3e03 }));
    smith.position.set(2,1,2);
    smith.userData.npc = true;
    scene.add(smith);

    // Speler
    const player = new THREE.Object3D(); // camera as head
    player.position.set(0,1.7,0);
    camera.position.set(0,0,0);
    player.add(camera);
    scene.add(player);

    // Pointer lock controls (mouse look)
    const controls = new THREE.PointerLockControls(camera, document.body);
    document.body.addEventListener('click', () => {
      if (!paused) controls.lock();
    });
    controls.getObject().position.copy(player.position);

    // HUD/overlay helpers
    const overlay = document.getElementById('overlay');
    const dialog = document.getElementById('dialog');
    const quest = document.getElementById('quest');
    const healthFill = document.getElementById('healthFill');
    const staminaFill = document.getElementById('staminaFill');

    // ====== Game state ======
    const STATE = {
      VILLAGE: 'VILLAGE',
      MINE: 'MINE',
      REWARD: 'REWARD',
      TRAINING: 'TRAINING',
      BATTLE: 'BATTLE',
      BOSS: 'BOSS',
      WIN: 'WIN'
    };
    let state = STATE.VILLAGE;

    const stats = {
      health: 100, maxHealth: 100,
      stamina: 100, maxStamina: 100,
      hasSword: false, hasShield: false, hasArmor: false
    };

    function updateBars() {
      healthFill.style.width = (stats.health / stats.maxHealth * 100) + '%';
      staminaFill.style.width = (stats.stamina / stats.maxStamina * 100) + '%';
    }

    // ====== Input ======
    const keys = {};
    document.addEventListener('keydown', (e) => {
      keys[e.code] = true;
      if (state === STATE.TRAINING && trainingPrompt && e.code === trainingPrompt.expected) {
        completeTraining();
      }
      if (e.code === 'KeyE') tryTalkSmith();
      if (e.code === 'Escape') togglePause();
    });
    document.addEventListener('keyup', (e) => keys[e.code] = false);

    // Mouse attack
    let attackCooldown = 0;
    document.addEventListener('mousedown', () => {
      if (paused) return;
      if (!stats.hasSword) return;
      if (attackCooldown > 0) return;
      attackCooldown = 0.4;
      swingSword();
    });

    // ====== Movement & collision ======
    const walkSpeed = 4;
    const sprintMultiplier = 1.8;

    function desiredMoveVector(dt) {
      const forward = new THREE.Vector3();
      controls.getDirection(forward);
      forward.y = 0; forward.normalize();

      const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).negate();

      let v = new THREE.Vector3();
      if (keys['KeyW']) v.add(forward);
      if (keys['KeyS']) v.sub(forward);
      if (keys['KeyA']) v.sub(right);
      if (keys['KeyD']) v.add(right);
      v.normalize();

      let speed = walkSpeed;
      if (keys['ShiftLeft'] && stats.stamina > 0.5) {
        speed *= sprintMultiplier;
        stats.stamina = Math.max(0, stats.stamina - 25*dt);
      }
      return v.multiplyScalar(speed * dt);
    }

    function aabbForSphere(pos, radius=0.5) {
      return new THREE.Box3(
        new THREE.Vector3(pos.x - radius, pos.y - radius, pos.z - radius),
        new THREE.Vector3(pos.x + radius, pos.y + radius, pos.z + radius)
      );
    }

    function collides(nextPos) {
      const playerBox = aabbForSphere(nextPos, 0.6);
      for (const o of obstacles) {
        const box = new THREE.Box3().setFromObject(o);
        if (box.intersectsBox(playerBox)) return true;
      }
      return false;
    }

    // ====== Quest: smid en mijn ======
    let ironNodes = [];
    let ironCollected = 0;

    function tryTalkSmith() {
      if (paused) return;
      if (state !== STATE.VILLAGE) return;
      const dist = player.position.distanceTo(smith.position);
      if (dist < 3) {
        dialog.style.display = 'block';
        dialog.innerHTML = '<b>Smid:</b> Ik heb 3 stukken ijzer nodig. Kun je ze voor me halen?';
        quest.textContent = 'Verzamel 3 stukken ijzer in de mijn';
        setTimeout(() => {
          dialog.style.display = 'none';
          goToMine();
        }, 2000);
      }
    }

    function goToMine() {
      state = STATE.MINE;
      // Teleport speler naar mijnlocatie
      player.position.set(-40, 1.7, -40);
      controls.getObject().position.copy(player.position);
      // Spawn 3 ijzerblokken
      ironNodes.forEach(n => scene.remove(n));
      ironNodes = [];
      ironCollected = 0;
      for (let i=0;i<3;i++) {
        const iron = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({ color:0x9ca3af, metalness:0.8, roughness:0.3 }));
        iron.position.set(-40 + (Math.random()*10-5), 0.5, -40 + (Math.random()*10-5));
        iron.userData.iron = true;
        scene.add(iron);
        ironNodes.push(iron);
      }
      dialog.style.display = 'block';
      dialog.innerHTML = '<b>Tip:</b> Loop naar de ijzerblokken en druk E om op te pakken.';
      setTimeout(()=> dialog.style.display='none', 2500);
    }

    function pickupCheck() {
      if (state !== STATE.MINE) return;
      for (const iron of ironNodes) {
        if (!iron.visible) continue;
        if (player.position.distanceTo(iron.position) < 2 && keys['KeyE']) {
          iron.visible = false;
          ironCollected++;
          quest.textContent = `Ijzer verzameld: ${ironCollected}/3`;
          if (ironCollected >= 3) {
            backToSmith();
          }
        }
      }
    }

    function backToSmith() {
      state = STATE.REWARD;
      // Teleport terug naar dorp
      player.position.set(0,1.7,0);
      controls.getObject().position.copy(player.position);
      // Beloning: zwaard + schild
      stats.hasSword = true; stats.hasShield = true;
      updateHotbar();
      dialog.style.display = 'block';
      dialog.innerHTML = '<b>Smid:</b> Goed gedaan! Hier is je zwaard en schild. Ga nu trainen.';
      quest.textContent = 'Voltooi de training (druk gevraagde toets)';
      setTimeout(()=> { dialog.style.display='none'; startTraining(); }, 2000);
    }

    function updateHotbar() {
      const slots = document.querySelectorAll('.slot');
      slots[0].textContent = stats.hasSword ? 'âš”' : '1';
      slots[1].textContent = stats.hasShield ? 'ðŸ›¡' : '2';
      slots[2].textContent = stats.hasArmor ? 'ðŸ¦º' : '3';
      slots[3].textContent = '4';
    }

    // ====== Training mini-game ======
    let trainingPrompt = null;
    function startTraining() {
      state = STATE.TRAINING;
      const keysList = ['KeyW','KeyA','KeyS','KeyD'];
      const pick = keysList[Math.floor(Math.random()*keysList.length)];
      const label = {KeyW:'W',KeyA:'A',KeyS:'S',KeyD:'D'}[pick];
      trainingPrompt = { expected: pick, label };
      overlay.style.display = 'flex';
      overlay.innerHTML = `<h2>Training</h2><div>Druk op toets: <b>${label}</b></div>`;
    }
    function completeTraining() {
      overlay.style.display = 'none';
      trainingPrompt = null;
      stats.hasArmor = true;
      updateHotbar();
      quest.textContent = 'Vijanden naderen! VerdÃ©dig je dorp.';
      startBattle();
    }

    // ====== Battlefase ======
    let enemies = [];
    function startBattle() {
      state = STATE.BATTLE;
      spawnEnemies(6);
    }
    function spawnEnemies(n) {
      enemies.forEach(e => scene.remove(e.mesh));
      enemies = [];
      for (let i=0;i<n;i++) {
        const mesh = new THREE.Mesh(new THREE.ConeGeometry(0.7,1.6,10), new THREE.MeshStandardMaterial({ color:0xe76f51 }));
        const pos = randomEdgePos();
        mesh.position.set(pos.x, 0.8, pos.z);
        scene.add(mesh);
        enemies.push({ mesh, hp: 30, speed: 2.2 });
      }
    }
    function randomEdgePos() {
      const s = 95;
      const edges = [
        {x: -s, z: (Math.random()*2*s - s)},
        {x: s, z: (Math.random()*2*s - s)},
        {x: (Math.random()*2*s - s), z: -s},
        {x: (Math.random()*2*s - s), z: s},
      ];
      return edges[Math.floor(Math.random()*edges.length)];
    }

    function updateEnemies(dt) {
      if (state !== STATE.BATTLE && state !== STATE.BOSS) return;
      for (const e of enemies) {
        const dir = new THREE.Vector3().subVectors(player.position, e.mesh.position);
        dir.y = 0; const dist = dir.length();
        dir.normalize();
        e.mesh.position.addScaledVector(dir, e.speed*dt);
        // Damage to player if close
        if (dist < 1.5) damagePlayer(12*dt);
      }
      // If all enemies defeated, spawn boss
      const alive = enemies.filter(e => e.hp > 0);
      if (alive.length === 0 && state === STATE.BATTLE) {
        startBoss();
      }
    }

    // ====== Zwaardaanval ======
    function swingSword() {
      // Simple hit cone in front of player
      const forward = new THREE.Vector3();
      controls.getDirection(forward); forward.y = 0; forward.normalize();
      const origin = player.position.clone();
      for (const e of enemies) {
        const toEnemy = new THREE.Vector3().subVectors(e.mesh.position, origin);
        toEnemy.y = 0;
        const dist = toEnemy.length();
        const angle = forward.angleTo(toEnemy.normalize());
        if (dist < 3 && angle < Math.PI/4) {
          e.hp -= 20;
          if (e.hp <= 0) {
            e.mesh.visible = false;
          }
        }
      }
      if (boss && boss.hp > 0) {
        const toBoss = new THREE.Vector3().subVectors(boss.mesh.position, origin);
        toBoss.y = 0;
        const dist = toBoss.length();
        const angle = forward.angleTo(toBoss.normalize());
        if (dist < 3 && angle < Math.PI/4) {
          boss.hp -= 15;
          if (boss.hp <= 0) {
            boss.mesh.visible = false;
            winGame();
          }
        }
      }
      // Stamina cost
      stats.stamina = Math.max(0, stats.stamina - 15);
    }

    // ====== Boss ======
    let boss = null;
    function startBoss() {
      state = STATE.BOSS;
      quest.textContent = 'Ga naar (85,85) en versla de eindbaas';
      // Spawn boss at ~ (85,85)
      const mesh = new THREE.Mesh(new THREE.BoxGeometry(2.2,3,2.2), new THREE.MeshStandardMaterial({ color:0x6a00f4 }));
      mesh.position.set(85,1.5,85);
      scene.add(mesh);
      boss = { mesh, hp: 120, speed: 1.6 };
      // Also spawn a couple adds
      spawnEnemies(4);
    }

    function updateBoss(dt) {
      if (!boss || boss.hp <= 0) return;
      const dist = boss.mesh.position.distanceTo(player.position);
      if (dist < 30) {
        const dir = new THREE.Vector3().subVectors(player.position, boss.mesh.position);
        dir.y = 0; dir.normalize();
        boss.mesh.position.addScaledVector(dir, boss.speed*dt);
      }
      if (dist < 2) damagePlayer(20*dt);
    }

    // ====== Health/stamina regen ======
    let regenTimer = 0;
    function updateRegen(dt) {
      regenTimer += dt;
      if (regenTimer >= 0.2) {
        regenTimer = 0;
        // Health regen langzaam
        stats.health = Math.min(stats.maxHealth, stats.health + 0.3);
        // Stamina regen sneller als niet sprint/aanval
        if (!keys['ShiftLeft']) stats.stamina = Math.min(stats.maxStamina, stats.stamina + 3);
      }
    }

    function damagePlayer(amount) {
      stats.health = Math.max(0, stats.health - amount);
      if (stats.health <= 0) {
        gameOver();
      }
    }

    function gameOver() {
      paused = true;
      overlay.style.display = 'flex';
      overlay.innerHTML = `<h2>Game Over</h2><div>Druk R om opnieuw te proberen</div>`;
      document.addEventListener('keydown', restartListener);
    }
    function restartListener(e) {
      if (e.code === 'KeyR') {
        document.removeEventListener('keydown', restartListener);
        location.reload();
      }
    }

    function winGame() {
      state = STATE.WIN;
      overlay.style.display = 'flex';
      overlay.innerHTML = `<h2>Gefeliciteerd!</h2><div>Je hebt Prinses Zelda bevrijd!</div>`;
      quest.textContent = 'Win!';
      paused = true;
    }

    // ====== Pauze ======
    let paused = false;
    function togglePause() {
      paused = !paused;
      overlay.style.display = paused ? 'flex' : 'none';
      overlay.innerHTML = paused ? '<h2>Gepauzeerd</h2><div>Druk Escape om te hervatten</div>' : '';
    }
    document.getElementById('pauseBtn').addEventListener('click', togglePause);

    // ====== Touch controls (NippleJS) ======
    const mobileControls = document.getElementById('mobile-controls');
    let leftManager = null, rightManager = null;
    function setupMobile() {
      const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      if (!isTouch) return;
      mobileControls.style.display = 'flex';
      // Left stick: movement
      leftManager = nipplejs.create({ zone: document.getElementById('left-stick'), mode: 'static', position: { left:'50%', top:'50%' }, color: 'white' });
      // Right stick: camera yaw
      rightManager = nipplejs.create({ zone: document.getElementById('right-stick'), mode: 'static', position: { left:'50%', top:'50%' }, color: 'white' });

      let mobileMove = new THREE.Vector3();
      leftManager.on('move', (evt, data) => {
        const rad = data.angle.radian;
        mobileMove.set(Math.cos(rad), 0, Math.sin(rad)); // local XY, map later
        mobileMove.normalize().multiplyScalar(data.distance/60); // scale
      });
      leftManager.on('end', () => mobileMove.set(0,0,0));
      rightManager.on('move', (evt,data) => {
        const deltaYaw = (data.vector.x) * 0.02;
        // yaw rotate player/camera
        const euler = new THREE.Euler(0, deltaYaw, 0, 'YXZ');
        controls.getObject().rotation.y += deltaYaw;
      });
      // Map mobileMove to WASD emulation in update loop
      mobileMoveVector = () => mobileMove.clone();
    }
    let mobileMoveVector = () => new THREE.Vector3();
    setupMobile();

    // ====== Main loop ======
    let last = performance.now();
    function loop(now) {
      requestAnimationFrame(loop);
      const dt = Math.min(0.033, (now - last)/1000);
      last = now;
      if (paused) {
        renderer.render(scene, camera);
        return;
      }

      // Movement
      let move = desiredMoveVector(dt);
      // Add mobile contribution
      const mm = mobileMoveVector();
      move.add(mm);

      const nextPos = player.position.clone().add(move);
      if (!collides(nextPos)) {
        player.position.copy(nextPos);
        controls.getObject().position.copy(nextPos);
      }

      // Mine pickup
      pickupCheck();

      // Attack cooldown
      if (attackCooldown > 0) attackCooldown = Math.max(0, attackCooldown - dt);

      // Enemies & boss
      updateEnemies(dt);
      updateBoss(dt);

      // Regen
      updateRegen(dt);
      updateBars();

      renderer.render(scene, camera);
    }
    requestAnimationFrame(loop);

    // ====== Boss spawn marker/hints ======
    const bossHint = new THREE.Mesh(new THREE.TorusGeometry(1.2,0.15,12,24), new THREE.MeshStandardMaterial({ color:0x6a00f4 }));
    bossHint.rotation.x = -Math.PI/2; bossHint.position.set(85,0.05,85);
    scene.add(bossHint);

    // ====== Start help text ======
    dialog.style.display = 'block';
    dialog.innerHTML = '<b>Tip:</b> Klik om muis te vergrendelen. Loop naar de smid en druk E.';
    setTimeout(()=> dialog.style.display='none', 2500);

    // ====== Window resize ======
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
